{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agentic Library - Discover Your Next Great Read</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'home.css' %}">
</head>

<body>
    <div class="container">
        <div class="logo">
            <h1><i class="fas fa-book-open"></i> Agentic Library</h1>
            <p>Discover your next great read by genre</p>
        </div>

        <div class="search-container">
            <form class="search-form" id="searchForm">
                <div class="search-group">
                    <input type="text" class="search-input" id="genreInput"
                        placeholder="Enter a book genre (e.g., mystery, romance, sci-fi, fantasy...)" autocomplete="off"
                        required>
                    <i class="fas fa-tags search-icon"></i>
                </div>

                <button type="submit" class="search-button" id="searchBtn">
                    <i class="fas fa-search"></i>
                    Search Books
                </button>
            </form>
        </div>

        <div class="popular-genres">
            <h3>Popular Genres</h3>
            <div class="genre-tags">
                <a href="#" class="genre-tag" onclick="searchGenre('mystery')">Mystery</a>
                <a href="#" class="genre-tag" onclick="searchGenre('romance')">Romance</a>
                <a href="#" class="genre-tag" onclick="searchGenre('fantasy')">Fantasy</a>
                <a href="#" class="genre-tag" onclick="searchGenre('sci-fi')">Sci-Fi</a>
                <a href="#" class="genre-tag" onclick="searchGenre('thriller')">Thriller</a>
                <a href="#" class="genre-tag" onclick="searchGenre('biography')">Biography</a>
                <a href="#" class="genre-tag" onclick="searchGenre('history')">History</a>
                <a href="#" class="genre-tag" onclick="searchGenre('self-help')">Self-Help</a>
            </div>
        </div>

        <div class="quick-tips">
            <h4><i class="fas fa-lightbulb"></i> Quick Tips</h4>
            <ul class="tips-list">
                <li>Try specific subgenres like "cozy mystery" or "urban fantasy"</li>
                <li>Combine genres like "historical fiction" or "romantic comedy"</li>
                <li>Search by mood: "feel-good books" or "dark fiction"</li>
                <li>Include time periods: "Victorian mystery" or "modern romance"</li>
            </ul>
        </div>
    </div>

    <script>
        // Handle form submission
        document.getElementById('searchForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const genreInput = document.getElementById('genreInput');
            const searchBtn = document.getElementById('searchBtn');
            const genre = genreInput.value.trim();

            if (genre) {
                performSearch(genre);
            }
        });

        // Function to perform search
        async function performSearch(genre) {

            console.log("Called performSearch with genre:", genre);
            const searchBtn = document.getElementById('searchBtn');
            const originalBtnContent = searchBtn.innerHTML;

            try {
                showLoadingState(searchBtn);
                const response = await fetch(`/books/search/?genre=${encodeURIComponent(genre)}`);
                if (!response.ok) {
                    throw new Error("Network response was not ok" + response.json());
                }
                const data = await response.json();
                displayResults(data.books, genre);
            } catch (error) {
                alert("Could not fetch books. Please try again later.\n" + data);
            }
            finally {
                hideLoadingState(searchBtn, originalBtnContent);
            }
        }

        // Function for genre tag clicks
        function searchGenre(genre) {
            document.getElementById('genreInput').value = genre;
            performSearch(genre);
        }

        function displayResults(books, genre) {
            let resultsContainer = document.querySelector('.results-container');

            // If results container doesn't exist, create it
            if (!resultsContainer) {
                resultsContainer = document.createElement('div');
                resultsContainer.className = 'results-container';
                document.querySelector('.container').appendChild(resultsContainer);
            }

            resultsContainer.innerHTML = `
        <h2>Books in "${genre}" genre</h2>
        <div class="books-grid">
            ${books.map(book => `
                <div class="book-card" onclick="showBookDetails(${JSON.stringify(book).replace(/"/g, '&quot;')})">
                    <img src="${book.image_url || '/static/default_cover.png'}" 
                        alt="${book.title}"
                        class="book-image">
                    <div class="book-info">
                        <h3 class="book-title">${book.title}</h3>
                        <p class="book-author">${book.author}</p>
                    </div>
                </div>
            `).join('')}
        </div>
    `;
        }

        // Function to show book details page
        function showBookDetails(book) {
            // Hide the main container and show book details
            document.querySelector('.container').style.display = 'none';

            // Remove any existing book-detail-container
            let oldDetail = document.querySelector('.book-detail-container');
            if (oldDetail) {
                oldDetail.parentNode.removeChild(oldDetail);
            }

            // Create detail container
            let bookDetailContainer = document.createElement('div');
            bookDetailContainer.className = 'book-detail-container';
            document.body.appendChild(bookDetailContainer);

            // Create detail container if it doesn't exist
            if (!bookDetailContainer) {
                bookDetailContainer = document.createElement('div');
                bookDetailContainer.className = 'book-detail-container';
                document.body.appendChild(bookDetailContainer);
            }

            // Populate book details
            bookDetailContainer.innerHTML = `
                <div class="book-detail">
                    <button class="back-button" onclick="goBackToResults()">
                        <i class="fas fa-arrow-left"></i> Back to Results
                    </button>
            
                    <div class="book-detail-content">
                        <div class="book-detail-image" class="book-image">
                            <img src="${book.image_url || '/static/default_cover.png'}" 
                                alt="${book.title}"
                                class="detail-image">
                        </div>
                
                        <div class="book-info">
                            <h1 class="detail-title">${book.title}</h1>
                            <p class="detail-author">by ${book.author}</p>
                    
                            <div class="book-meta">
                                ${book.genre ? `<p><strong>Genre:</strong> ${book.genre}</p>` : ''}
                                ${book.published_year ? `<p><strong>Published:</strong> ${book.published_year}</p>` : ''}
                                ${book.pages ? `<p><strong>Pages:</strong> ${book.pages}</p>` : ''}
                                ${book.isbn ? `<p><strong>ISBN:</strong> ${book.isbn}</p>` : ''}
                            </div>
                    
                            ${book.description ? `
                                <div class="book-info">
                                    <h3>Description</h3>
                                    <p>${book.description}</p>
                                </div>
                            ` : ''}
                    
                            ${book.publisher ? `<p><strong>Publisher:</strong> ${book.publisher}</p>` : ''}
                    
                            <div class="action-buttons">
                                <button id="summary-btn" class="action-btn summary-btn" onclick="generateSummary('${encodeURIComponent(book.title)}', '${encodeURIComponent(book.author)}')">
                                    <i class="fas fa-magic"></i> Generate Summary
                                </button>
                            </div>
                            <div id="summary-box" style="display:none; margin-top:18px;">
                                <textarea id="summary-text" rows="6" style="width:100%; min-height:220px; border-radius:8px; padding:16px; font-size:1.08rem;" readonly placeholder="Summary will appear here..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            bookDetailContainer.style.display = 'block';

            //document.getElementById('summary-btn').onclick = function() {
            //generateSummary(book.title, book.author);
            //};
        }

        // Function to go back to search results
        function goBackToResults() {
            document.querySelector('.book-detail-container').style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        function generateSummary(title, author) {
            console.log("Generating summary for:", title, "by", author);

            const summaryBtn = document.getElementById('summary-btn');
            const summaryBox = document.getElementById('summary-box');
            const summaryText = document.getElementById('summary-text');
            summaryBox.style.display = 'block';
            summaryText.value = "";

            summaryBtn.disabled = true;
            const originalBtnContent = summaryBtn.innerHTML;
            summaryBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i> Generating...`;
            // You can replace the line above with an AJAX call to your backend to get the summary
            fetch('/books/summary/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ title: title })
            })
                .then(response => {
                    const reader = response.body.getReader();
                    const decoder = new TextDecoder();
                    function read() {
                        reader.read().then(({ done, value }) => {
                            if (done) {
                                summaryBtn.disabled = false;
                                summaryBtn.innerHTML = originalBtnContent;
                                return;
                            }
                            const chunk = decoder.decode(value);
                            chunk.split('\n').forEach(line => {
                                if (line.startsWith('data: ')) {
                                    summaryText.value += line.replace('data: ', '');
                                }
                            });
                            read();
                        });
                    }
                    read();
                })
                .catch(error => {
                    summaryText.value = "Error generating summary.";
                    summaryBtn.disabled = false;
                    summaryBtn.innerHTML = originalBtnContent;
                });
        }

        // Handle browser back button
        window.addEventListener('popstate', function (event) {
            goBackToResults();
        });

        // Show loading state
        function showLoadingState(button) {
            button.disabled = true;
            button.innerHTML = `
        <i class="fas fa-spinner fa-spin"></i>
        Searching...
    `;
            button.style.opacity = '0.7';
        }

        // Hide loading state
        function hideLoadingState(button, originalContent) {
            button.disabled = false;
            button.innerHTML = originalContent;
            button.style.opacity = '1';
        }

        // Auto-complete suggestions (basic implementation)
        const genreInput = document.getElementById('genreInput');
        const popularGenres = [
            'mystery', 'romance', 'fantasy', 'sci-fi', 'thriller', 'biography',
            'history', 'self-help', 'horror', 'adventure', 'comedy', 'drama',
            'crime', 'western', 'contemporary fiction', 'historical fiction',
            'young adult', 'children', 'poetry', 'philosophy', 'psychology',
            'business', 'health', 'cooking', 'travel', 'art', 'music'
        ];

        genreInput.addEventListener('input', function () {
            const value = this.value.toLowerCase();
            // Here you could implement a dropdown with suggestions
            // For now, we'll just ensure the input is clean
            this.value = this.value.replace(/[^a-zA-Z\s-]/g, '');
        });

        // Focus on search input when page loads
        window.addEventListener('load', function () {
            genreInput.focus();
        });
    </script>
</body>

</html>